<!-- ===== Endora: Chat + QR (vertical, black background) ===== -->
<div class="apt-landing"
     style="
       --bg:#000000; --ink:#e9f1ee; --muted:#aab7b1; --acc:#bff2da; --card:#171717; --ring:rgba(191,242,218,.25);
       /* Transparenz & Effekte */
       --chat_msg_alpha:.35; --wall2_dim:.35; --chat_glass_alpha:.30; --chat_blur:10px; --input_alpha:.35;
       /* QR-Plate & Gr√∂√üe */
       --qr_size:148px;
       --qr_plate_alpha:.72;
       --qr_blur:8px;
       --bubble_size:40px;
       /* Wallpaper hinter dem Chat */
       --wall2:url('https://d1yei2z3i6k35z.cloudfront.net/12820362/68a47346dc795_ModernCozyLivingRoom.jpeg?width=1920');
       font-family:Arial,system-ui; position:relative">
  <style>
    /* Schwarzer Hintergrund & gleiche Struktur behalten */
    .apt-landing{
      color:var(--ink);
      background:var(--bg);
      border:1px solid rgba(255,255,255,.08);
      border-radius:20px;
      padding:24px
    }

    /* Immer EINSPALTIG (untereinander) */
    .apt-grid{display:grid; gap:22px; align-items:start; grid-template-columns:1fr}
    @media(min-width:880px){ .apt-grid{grid-template-columns:1fr} } /* √ºberschreibt fr√ºhere 2-Spalten-Regel */

    .apt-card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:22px}

    .apt-h1{margin:0 0 14px;text-align:center;line-height:1.15}
    .apt-h1 .prefix,.apt-h1 .main{display:block;font-weight:800;color:var(--ink);font-size:clamp(1.1rem,2.2vw,1.7rem)}
    .apt-h1 .main{white-space:nowrap}
    @media(max-width:420px){ .apt-h1 .prefix,.apt-h1 .main{font-size:1.05rem} }

    .apt-lead{margin:0 0 18px;color:var(--muted);text-align:center;font-weight:400}
    .apt-badges{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 18px;justify-content:center}
    .apt-pill{display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--ring);border-radius:999px;padding:7px 12px;color:var(--acc);background:rgba(191,242,218,.10);font-weight:800;text-decoration:none;line-height:1}
    .apt-ul{margin:14px 0 0 0; list-style-position:inside; text-align:center}
    .apt-ul li{margin-bottom:10px}

    .apt-row{display:flex;justify-content:center}
    .apt-row-inner{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center;margin-top:20px}
    .apt-cta{display:inline-flex;align-items:center;gap:.5rem;padding:8px 14px;border-radius:999px;background:var(--acc);color:#0e1f17;font-weight:800;text-decoration:none;box-shadow:0 10px 24px rgba(191,242,218,.35);line-height:1;white-space:nowrap}
    .apt-cta.ghost{background:transparent;color:var(--acc);border:1px solid var(--ring);box-shadow:none}

    /* ===== Chat + QR ===== */
    .chat-host{position:relative;overflow:hidden}
    .chat-host::before{
      content:""; position:absolute; inset:0; z-index:0; border-radius:16px;
      background: linear-gradient(rgba(0,0,0,var(--wall2_dim)), rgba(0,0,0,var(--wall2_dim))), var(--wall2, none);
      background-size:cover; background-position:center;
    }
    .chat-host > *{position:relative; z-index:1}

    .chat-window{
      display:flex;flex-direction:column;width:100%;max-width:420px;height:440px;color:#fff;border-radius:10px;
      overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.08);
      background: rgba(18,18,18,var(--chat_glass_alpha));
      backdrop-filter: blur(var(--chat_blur)); -webkit-backdrop-filter: blur(var(--chat_blur));
      margin-inline:auto
    }
    .chat-header{background:var(--acc);color:#000;padding:10px 12px;font-weight:800;display:flex;align-items:center;justify-content:space-between}
    .chat-close{background:transparent;border:0;color:#000;font-weight:900;font-size:18px;cursor:pointer}

    .chat-messages{position:relative;flex:1;overflow-y:auto;padding:12px 12px 14px;font-size:14px;display:flex;flex-direction:column;background: rgba(24,24,24,var(--chat_msg_alpha))}
    .msg{margin:7px 0;padding:8px 10px;border-radius:8px;max-width:92%}
    .user{background:rgba(255,255,255,.10);align-self:flex-end}
    .bot{background:rgba(0,0,0,.35);align-self:flex-start}
    .chat-input-area{display:flex;border-top:1px solid #444}
    .chat-input{flex:1;border:none;padding:11px 10px;font-size:14px;background: rgba(46,46,46,var(--input_alpha)); color:#fff}
    .chat-input:focus{outline:none}
    .chat-send{background:var(--acc);color:#000;border:none;padding:0 16px;cursor:pointer;font-weight:800}

    .chat-actions{display:flex;align-items:center;justify-content:center;gap:18px;margin:16px auto 0;max-width:420px}
    .apt-qr-wrap{position:relative;width:var(--qr_size);height:var(--qr_size)}
    .apt-qr{
      position:absolute;inset:0;border-radius:14px;
      background: transparent; border:1px solid rgba(255,255,255,.22);
      box-shadow:0 10px 24px rgba(0,0,0,.40); display:grid; place-items:center; overflow:hidden
    }
    .apt-qr::before{
      content:""; position:absolute; inset:2px; border-radius:12px;
      background: rgba(255,255,255,var(--qr_plate_alpha));
      backdrop-filter: blur(var(--qr_blur)); -webkit-backdrop-filter: blur(var(--qr_blur));
      z-index:0; box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }
    .apt-qr img{position:relative; z-index:1; width:100%; height:100%; object-fit:contain; image-rendering:pixelated; image-rendering:crisp-edges;}

    .chat-toggle{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:var(--bubble_size); height:var(--bubble_size); border-radius:50%;
      background: rgba(191,242,218,.75);
      color:#0b1b15; font-size:18px; display:grid; place-items:center; cursor:pointer;
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 22px rgba(191,242,218,.35), 0 0 0 1px rgba(255,255,255,.55) inset;
      z-index:2
    }
    .chat-toggle::after{
      content:""; position:absolute; inset:0; border-radius:50%;
      background: radial-gradient(120% 120% at 30% 25%, rgba(255,255,255,.45) 0%, rgba(255,255,255,0) 60%);
      pointer-events:none;
    }
    .chat-badge{position:absolute;top:-6px;right:-6px;background:red;color:#fff;font-size:11px;padding:2px 6px;border-radius:50%;display:none}

    .popup-wrap{position:absolute;left:calc(50% - 210px); bottom:210px; z-index:6; display:none}
    @media(max-width:520px){ .popup-wrap{left:8px; right:8px} }
    @media(max-width:600px){ .apt-qr-wrap{width:132px;height:132px} .chat-window{height:420px} }

    .chat-messages a, .chat-messages a:visited { color: var(--acc); }
  </style>

  <div class="apt-grid">
    <!-- LEFT -->
    <div class="apt-card">
      <h2 class="apt-h1">
        <span class="prefix">Willkommen bei deinem</span>
        <span class="main">Endora üõéÔ∏è</span>
      </h2>
      <p class="apt-lead">Frag einfach los ‚Äì zu Check-in, Hausregeln, Ausstattung oder Tipps in der Umgebung. Endora hilft dir sofort weiter.</p>

      <div class="apt-badges">
        <span class="apt-pill">üïí 24/7 G√§steservice</span>
        <span class="apt-pill">üçΩÔ∏è Insider-Tipps & Aktivit√§ten</span>
        <span class="apt-pill">üîí Datenschutzfreundlich</span>
        <a class="apt-pill" href="mailto:contact@eudemonia-coaching.de?subject=White%20Label%20ready">üè∑Ô∏è White Label ready</a>
        <a class="apt-pill" href="mailto:contact@eudemonia-coaching.de?subject=Franchise%20Programm">ü§ù Franchise Programm</a>
        <a class="apt-pill" href="mailto:contact@eudemonia-coaching.de?subject=Affiliate-Link%20Datenbank%20%28Services%20%26%20Buchungen%29">üîó Affiliate-Link Datenbank</a>
      </div>

      <ul class="apt-ul">
        <li>WLAN, Parkplatz, Ger√§te-Guides, M√ºll & Recycling</li>
        <li>Beste Restaurants, Str√§nde, Touren & Transport</li>
        <li>Buchbare Extras: Early/Late Check-out, Beauty-Behandlung, Private Chef, Inhouse Massage, Shuttle <strong>(Es kann sich um Affiliate-Links handeln)</strong></li>
      </ul>

      <div class="apt-row">
        <div class="apt-row-inner">
          <a class="apt-cta"   href="mailto:contact@eudemonia-coaching.de?subject=GPT%20bestellen%20%28inkl.%20Landingpage%29">GPT-Bestellen (inkl. Landingpage)</a>
          <a class="apt-cta ghost" href="mailto:contact@eudemonia-coaching.de?subject=GPT%20bestellen%20%28ohne%20Landingpage%29">GPT-Bestellen (ohne Landingpage)</a>
        </div>
      </div>
    </div>

    <!-- RIGHT (unter dem ersten Card) -->
    <div class="apt-card chat-host" id="openChat">
      <div class="chat-window" id="inline-chat">
        <div class="chat-header">
          <span>üí¨ Endora</span>
          <button class="chat-close" id="inline-close" title="Minimieren" style="display:none">√ó</button>
        </div>
        <div class="chat-messages" id="inline-messages"></div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="inline-input" placeholder="Frag z. B.: 'Wo kann ich heute gut essen?'" />
          <button class="chat-send" id="inline-send">Senden</button>
        </div>
      </div>

      <!-- QR + Bubble -->
      <div class="chat-actions">
        <div class="apt-qr-wrap">
          <a class="apt-qr" id="apt-qr" href="#openChat" title="Scannen zum √ñffnen des Chats">
            <img id="apt-qr-img" alt="QR zum √ñffnen des Chats" />
          </a>
          <div class="chat-toggle" id="bubble-btn" aria-label="Chat √∂ffnen">üí¨
            <span class="chat-badge" id="bubble-badge">1</span>
          </div>
        </div>
      </div>

      <!-- Popup -->
      <div class="popup-wrap" id="popup-wrap">
        <div class="chat-window" id="popup-chat">
          <div class="chat-header">
            <span>üí¨ Endora</span>
            <button class="chat-close" id="popup-close" title="Schlie√üen">√ó</button>
          </div>
          <div class="chat-messages" id="popup-messages"></div>
          <div class="chat-input-area">
            <input type="text" class="chat-input" id="popup-input" placeholder="Frag z. B.: 'Wie l√§uft der Check-in?'" />
            <button class="chat-send" id="popup-send">Senden</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TECH: Loader nutzen (URL wird automatisch kanonisiert: origin + pathname) -->
  <script>
    (function(){
      var s = document.createElement('script');
      s.src = '/chat-interface-tech-config/v1/coreloader.js';

      // ‚úÖ client_api_id
      var CLIENT_API_ID = 'test_client_l';
      s.setAttribute('data-client-api-id', CLIENT_API_ID);
      s.setAttribute('data-chat-endpoint', 'https://pages.endora.io/api/chat');

      s.setAttribute('data-brand', 'Endora');
      s.setAttribute('data-start-open', 'false');

      // canonical page url (no query/hash)
      var canonical = location.origin + location.pathname;
      s.setAttribute('data-page-url', canonical);

      document.body.appendChild(s);
    })();
  </script>

  <!-- ‚úÖ FIX: QR sichtbar + Send/Enter + Popup open/close (Design unver√§ndert) -->
  <script>
  (function(){
    const CLIENT_API_ID = "test_client_l";
    const CHAT_ENDPOINT = "https://pages.endora.io/api/chat?client=" + encodeURIComponent(CLIENT_API_ID);

    const inlineMessages = document.getElementById("inline-messages");
    const inlineInput = document.getElementById("inline-input");
    const inlineSend = document.getElementById("inline-send");

    const popupWrap = document.getElementById("popup-wrap");
    const popupMessages = document.getElementById("popup-messages");
    const popupInput = document.getElementById("popup-input");
    const popupSend = document.getElementById("popup-send");
    const popupClose = document.getElementById("popup-close");

    const bubbleBtn = document.getElementById("bubble-btn");
    const qrImg = document.getElementById("apt-qr-img");
    const qrLink = document.getElementById("apt-qr");

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function linkifyHtml(text){
      const safe = escapeHtml(text);
      const re = /((https?:\/\/|www\.)[^\s<>"']+)/gi;
      return safe.replace(re, (m)=>{
        const href = m.startsWith("www.") ? ("https://" + m) : m;
        return '<a href="'+escapeHtml(href)+'" target="_blank" rel="noopener">'+escapeHtml(m)+'</a>';
      });
    }
    function addMsg(container, text, who){
      if(!container) return;
      const div = document.createElement("div");
      div.className = "msg " + (who === "user" ? "user" : "bot");
      div.innerHTML = linkifyHtml(text || "");
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    async function ask(container, inputEl, sendBtn){
      const text = (inputEl.value || "").trim();
      if(!text) return;

      addMsg(container, text, "user");
      inputEl.value = "";
      sendBtn.disabled = true;

      try{
        const res = await fetch(CHAT_ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json, text/plain;q=0.9,*/*;q=0.8"
          },
          body: JSON.stringify({
            message: text,
            url: window.location.href,
            meta: { source: "endora-landing-vertical" }
          })
        });

        const ct = (res.headers.get("content-type") || "").toLowerCase();
        let data = null;
        let raw = "";

        if(ct.includes("application/json")){
          try{ data = await res.json(); }catch(_){ data = null; }
        } else {
          try{ raw = await res.text(); }catch(_){ raw = ""; }
          try{ data = JSON.parse(raw); }catch(_){ /* ignore */ }
        }

        const reply =
          (data && (data.reply || data.output || data.answer || data.message || data.text)) ||
          (raw && raw.trim()) ||
          "Keine Antwort erhalten.";

        addMsg(container, String(reply).trim(), "bot");
      } catch(e){
        addMsg(container, "Verbindungsproblem ‚Äî bitte gleich nochmal versuchen.", "bot");
      } finally{
        sendBtn.disabled = false;
      }
    }

    function wireChat(container, inputEl, sendBtn){
      if(!container || !inputEl || !sendBtn) return;

      if(container.children.length === 0){
        addMsg(container, "Willkommen! üëã Ich bin Endora ‚Äì dein digitaler Concierge. Frag mich alles rund um deinen Aufenthalt.", "bot");
      }

      sendBtn.addEventListener("click", ()=>ask(container, inputEl, sendBtn));
      inputEl.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          ask(container, inputEl, sendBtn);
        }
      });
    }

    function openPopup(){
      if(popupWrap) popupWrap.style.display = "block";
      setTimeout(()=>{ try{ popupInput && popupInput.focus(); }catch(_){} }, 50);
    }
    function closePopup(){
      if(popupWrap) popupWrap.style.display = "none";
    }

    // Wire chats
    wireChat(inlineMessages, inlineInput, inlineSend);
    wireChat(popupMessages, popupInput, popupSend);

    // Bubble toggles popup
    if(bubbleBtn) bubbleBtn.addEventListener("click", openPopup);
    if(popupClose) popupClose.addEventListener("click", closePopup);

    // QR: set visible/scannable (hi-res + margin)
    if(qrImg){
      const target = window.location.origin + window.location.pathname + "#openChat";
      qrImg.src = "https://api.qrserver.com/v1/create-qr-code/?size=512x512&margin=16&data=" + encodeURIComponent(target);
    }

    // QR click: scroll+focus inline chat
    if(qrLink){
      qrLink.addEventListener("click", function(){
        const el = document.getElementById("openChat");
        if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
        setTimeout(()=>{ try{ inlineInput && inlineInput.focus(); }catch(_){} }, 250);
      });
    }

    // if opened with hash already
    if(window.location.hash === "#openChat"){
      const el = document.getElementById("openChat");
      if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
      setTimeout(()=>{ try{ inlineInput && inlineInput.focus(); }catch(_){} }, 250);
    }
  })();
  </script>
</div>
<!-- ===== Ende ===== -->
